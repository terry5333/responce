<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿä½œæ¥­ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; }
        .worksheet-content { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; }
        
        .worksheet-input {
            border: 2px solid #e2e8f0; /* é‚Šæ¡†é¡è‰² */
            padding: 4px 6px;          /* ç¸®å°å…§è·ï¼Œè®“æ–‡å­—ä¸æœƒå¤ªæ“æ“ ä½†ä¹Ÿä¸æœƒæ’å¤§æ ¼å­ */
            border-radius: 4px;
            margin: 0 !important;      /* â˜…é—œéµï¼šæ­¸é›¶ï¼Œé¿å…ä½ç½®åç§» */
            box-sizing: border-box;    /* â˜…é—œéµï¼šç¢ºä¿å…§è·ä¸æœƒæ’å¤§è¨­å®šå¥½çš„å¯¬é«˜ */
            transition: border-color 0.2s;
            background-color: rgba(255, 255, 255, 0.9); /* ç¨å¾®ä¸é€æ˜ï¼Œé¿å…è·Ÿåº•åœ–æ··åœ¨ä¸€èµ· */
            line-height: 1.2;          /* ä¿®æ­£æ–‡å­—å‚ç›´ä½ç½® */
        }
        
        .worksheet-input:focus {
            border-color: #3b82f6;
            outline: none;
            background-color: #fff;
            z-index: 20; /* é»æ“Šæ™‚æµ®åˆ°æœ€ä¸Šå±¤ */
        }

        /* é‡å°æ–‡å­—æ¡†èˆ‡ä¸‹æ‹‰é¸å–®ï¼Œåªéœ€ç¢ºä¿ display æ­£ç¢ºï¼Œä¸è¦å¼·åˆ¶ width: 100% */
        textarea.worksheet-input,
        select.worksheet-input,
        input[type="text"].worksheet-input,
        input[type="number"].worksheet-input,
        input[type="date"].worksheet-input {

        }

        /* ä¿®æ­£ Checkbox çš„å°é½Š */
        input[type="radio"].worksheet-input,
        input[type="checkbox"].worksheet-input {
            margin: 0;
            cursor: pointer;
        }
        
        /* æ‰¹æ”¹é¢æ¿æ¨£å¼ */
        .grading-panel {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #94a3b8;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 0 4px 4px 0;
            margin-top: 5px;
            position: relative;
            z-index: 10;
        }
        .grading-panel.correct { border-left-color: #22c55e; background-color: #f0fdf4; }
        .grading-panel.incorrect { border-left-color: #ef4444; background-color: #fef2f2; }
        
        .grading-status-text { font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .text-correct { color: #166534; }
        .text-incorrect { color: #991b1b; }
		
		/* --- æ–°å¢ï¼šå­¸ç”Ÿç«¯å¾®èª¿åŠŸèƒ½æ¨£å¼ --- */
        .move-mode-active .worksheet-input {
            /* é è¨­æ¸¸æ¨™ç‚ºç§»å‹• */
            cursor: move; 
            /* é‚Šæ¡†è®Šæ©˜è‰²è™›ç·šï¼Œæ›´æ˜é¡¯ */
            border: 2px dashed #f97316 !important; 
            box-shadow: 0 4px 6px rgba(249, 115, 22, 0.2);
            user-select: none;
            /* é—œéµï¼šè®“å…ƒç´ å¯ä»¥ç”¨æ»‘é¼ èª¿æ•´å¤§å°çš„ CSS å±¬æ€§ (å° textarea æœ‰æ•ˆï¼Œå° input éœ€é  JS è¼”åŠ©) */
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿç€è¦½å™¨é è¨­çš„æ»¾å‹•è¡Œç‚ºå¹²æ“¾æ‹–æ›³ */
        }
        
        /* ç•¶æ»‘é¼ ç§»åˆ°å³ä¸‹è§’æ™‚ï¼Œæ”¹è®Šæ¸¸æ¨™å½¢ç‹€ (é€™åªæ˜¯è¦–è¦ºè¼”åŠ©ï¼Œå¯¦éš›é‚è¼¯åœ¨ JS) */
        /* ç”±æ–¼ CSS ç„¡æ³•ç›´æ¥é¸å– input çš„è§’è½ï¼Œæˆ‘å€‘ç”¨ JS å‹•æ…‹æ§åˆ¶ cursor æˆ–è€…å–®ç´”ä¾é ä½¿ç”¨ç›´è¦º */
        .move-mode-active .worksheet-input:hover {
            background-color: rgba(255, 247, 237, 0.9);
        }

        #adjust-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999; /* å±¤ç´šæ‹‰é«˜ */
            background: white;
            padding: 8px 16px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            gap: 10px;
            align-items: center;
            border: 1px solid #e5e7eb;
        }
		
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="login-view" class="flex flex-col items-center justify-center h-screen px-4">
        <div class="bg-white p-8 rounded-xl shadow-xl text-center w-full max-w-md">
            <h1 class="text-3xl font-extrabold text-blue-600 mb-2">å­¸ç”Ÿä½œæ¥­ç³»çµ±</h1>
            <p class="mb-8 text-gray-500">è«‹ä½¿ç”¨å­¸æ ¡ Google å¸³è™Ÿç™»å…¥</p>
            
            <button id="login-btn" class="bg-white border border-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-50 transition shadow-sm w-full">
                Google ç™»å…¥
            </button>
            <p id="login-msg" class="mt-4 text-sm text-red-500 font-bold"></p>
        </div>
    </div>

    <div id="app-view" class="container mx-auto p-4 max-w-5xl hidden">
        <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm mb-6 sticky top-0 z-10">
            <div class="flex items-center gap-3">
                <div class="bg-blue-100 p-2 rounded-full text-blue-600 font-bold text-xl">ğŸ“</div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800" id="student-name">è¼‰å…¥ä¸­...</h1>
                    <p class="text-sm text-gray-500 font-bold" id="class-info">...</p>
                </div>
            </div>
            <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-500 font-medium px-3 py-1 border rounded hover:bg-red-50 transition">ç™»å‡º</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <h2 class="text-xl font-bold text-gray-700 flex items-center gap-2">
                    ğŸ“ å¾…å®Œæˆä»»å‹™ 
                    <span id="todo-count" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">0</span>
                </h2>
                <div id="todo-list" class="space-y-3">
                    <p class="text-gray-400 text-center py-8">ç›®å‰æ²’æœ‰å¾…å®Œæˆçš„ä½œæ¥­ ğŸ‰</p>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-xl font-bold text-gray-700">âœ… å·²ç¹³äº¤ / æˆç¸¾</h2>
                <div id="history-list" class="space-y-3 opacity-80">
                    <p class="text-gray-400 text-center py-8">å°šç„¡ç´€éŒ„</p>
                </div>
            </div>
        </div>
    </div>

    <div id="worksheet-modal" class="fixed inset-0 bg-gray-100 z-50 hidden overflow-y-auto">
        <div class="min-h-screen flex flex-col max-w-4xl mx-auto bg-white shadow-2xl">
            
            <div class="sticky top-0 z-20 bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm">
                <div>
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800">ä½œæ¥­æ¨™é¡Œ</h3>
                    <div id="modal-status-container" class="flex gap-2 mt-1">
                        <span id="modal-status" class="text-xs font-bold px-2 py-0.5 rounded bg-gray-200 text-gray-600">ç‹€æ…‹</span>
                    </div>
                </div>
                <button onclick="saveLocalAndClose()" class="text-gray-500 hover:text-gray-800 transition p-2 rounded-full hover:bg-gray-100" title="æš«æ™‚é›¢é–‹ (è‡ªå‹•å­˜å…¥æœ¬æ©Ÿ)">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-grow p-6 md:p-10 bg-white">
                
                <div id="teacher-feedback-area" class="hidden mb-8 p-6 bg-yellow-50 border-l-4 border-yellow-400 rounded-r text-base text-yellow-800 shadow-sm">
                    <strong class="block mb-2 text-lg">ğŸ‘©â€ğŸ« è€å¸«ç¸½è©•ï¼š</strong> 
                    <span id="feedback-text" class="leading-relaxed"></span>
                </div>

                <form id="worksheet-form" class="worksheet-content space-y-6" onsubmit="return false;">
                </form>
            </div>

            <div class="p-6 border-t bg-gray-50 sticky bottom-0 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                <div id="action-buttons" class="flex flex-col md:flex-row justify-between items-center gap-4">
                    
                    <div class="flex gap-3 w-full md:w-auto">
                        <button id="btn-leave-temp" class="flex-1 md:flex-none px-4 py-2 text-gray-600 font-bold hover:bg-gray-200 rounded-lg transition border border-gray-300 bg-white text-sm flex items-center justify-center gap-1">
                            ğŸšª æš«æ™‚é›¢é–‹ <span class="text-xs font-normal text-gray-500">(å­˜æœ¬æ©Ÿ)</span>
                        </button>
                        <button id="btn-save-cloud" class="flex-1 md:flex-none px-4 py-2 text-orange-700 font-bold hover:bg-orange-100 rounded-lg transition border border-orange-300 bg-white text-sm flex items-center justify-center gap-1">
                            â˜ï¸ æš«å­˜é›²ç«¯ <span class="text-xs font-normal text-orange-500">(å¯è·¨è£ç½®)</span>
                        </button>
                    </div>

                    <button id="btn-submit" class="w-full md:w-auto px-8 py-2.5 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md transform hover:-translate-y-0.5 transition flex items-center justify-center gap-2">
                        <span>âœ… å®Œæˆç¹³äº¤</span>
                    </button>
                </div>
                
                <div id="readonly-buttons" class="hidden text-right">
                    <button onclick="closeModal()" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded">é—œé–‰è¦–çª—</button>
                </div>
            </div>
        </div>
		<div id="adjust-controls" class="hidden">
			<button id="toggle-move-btn" onclick="toggleStudentMoveMode()" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-full font-bold text-sm shadow transition flex items-center gap-2">
				ğŸ”“ è§£é–èª¿æ•´ä½ç½®
			</button>
			<button onclick="resetStudentPositions()" class="bg-red-100 hover:bg-red-200 text-red-600 px-3 py-2 rounded-full font-bold text-xs shadow transition hidden" id="reset-pos-btn" title="é‡ç½®å›é è¨­ä½ç½®">
				ğŸ”„ é‡ç½®
			</button>
		</div>
    </div>

    <script>
        // -----------------------------------------------------------
        // 1. åˆå§‹åŒ–èˆ‡è¨­å®š
        // -----------------------------------------------------------
        
        // è¼”åŠ©å‡½å¼ï¼šå¼·åˆ¶åŸ·è¡Œ script ä¸¦æ¸²æŸ“ MathJax
        function executeEmbeddedScripts(container) {
            const scripts = container.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
            if (window.MathJax) {
                MathJax.typesetPromise([container]).catch((err) => console.log('MathJax error:', err));
            }
        }

        const firebaseConfig = {
            apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
            authDomain: "classrecords-13902.firebaseapp.com",
            projectId: "classrecords-13902",
            storageBucket: "classrecords-13902.firebasestorage.app",
            messagingSenderId: "431747377367",
            appId: "1:431747377367:web:b157a485c59ce38091e892",
            measurementId: "G-JWTQGM9XMP"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        // â˜ï¸ã€æ–°å¢ã€‘åˆå§‹åŒ– Storage
        const storage = firebase.storage();

        let currentUser = null;
        let studentProfile = null;
        let currentAssignmentId = null;
        // â˜ï¸ã€æ–°å¢ã€‘ç´€éŒ„ç›®å‰è¼‰å…¥çš„ç­”æ¡ˆ (ç”¨æ–¼ä¿ç•™æœªä¿®æ”¹çš„æª”æ¡ˆé€£çµ)
        let currentLoadedAnswers = {}; 

        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginMsg = document.getElementById('login-msg');

        // -----------------------------------------------------------
        // 2. èº«åˆ†é©—è­‰ (Login/Auth)
        // -----------------------------------------------------------
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                loginMsg.textContent = 'æ­£åœ¨ç¢ºèªå­¸ç”Ÿèº«åˆ†...';
                currentUser = user;
                
                try {
                    let userDoc = await db.collection('users').doc(user.uid).get();

                    if (userDoc.exists) {
                        studentProfile = userDoc.data();
                        // è£œé½Šå­¸æ ¡åç¨±
                        if (!studentProfile.schoolName && studentProfile.schoolId) {
                            try {
                                const sDoc = await db.collection('schools').doc(studentProfile.schoolId).get();
                                if(sDoc.exists) studentProfile.schoolName = sDoc.data().name;
                            } catch(e) {}
                        }
                    } else {
                        // é¦–æ¬¡ç™»å…¥ï¼šå˜—è©¦å¾ students é›†åˆå°‹æ‰¾ Email
                        const snapshot = await db.collectionGroup('students')
                                                 .where('email', '==', user.email)
                                                 .get();

                        if (!snapshot.empty) {
                            const studentDoc = snapshot.docs[0];
                            const studentData = studentDoc.data();
                            const schoolRef = studentDoc.ref.parent.parent;
                            const schoolId = schoolRef.id;
                            let schoolName = schoolId;
                            
                            try {
                                const schoolSnap = await schoolRef.get();
                                if(schoolSnap.exists && schoolSnap.data().name) schoolName = schoolSnap.data().name;
                            } catch(e) {}

                            const newProfile = {
                                role: 'student',
                                email: user.email,
                                displayName: studentData.name,
                                schoolId: schoolId,
                                schoolName: schoolName,
                                classId: studentData.class_id,
                                seatNo: studentData.seat_no,
                                fullId: studentData.full_id
                            };
                            
                            await db.collection('users').doc(user.uid).set(newProfile);
                            studentProfile = newProfile;
                        } else {
                            throw new Error(`æ‰¾ä¸åˆ°æ‚¨çš„å­¸ç”Ÿè³‡æ–™ (Email: ${user.email})ã€‚è«‹è¯ç¹«è€å¸«ç¢ºèªã€‚`);
                        }
                    }

                    if (studentProfile.role !== 'student') throw new Error('æ­¤å¸³è™Ÿç‚ºæ•™å¸«èº«åˆ†ï¼Œç„¡æ³•ç™»å…¥å­¸ç”Ÿç«¯ã€‚');

                    renderDashboard();
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');

                } catch (e) {
                    console.error("ç™»å…¥æµç¨‹éŒ¯èª¤:", e);
                    let errorHtml = `<div class="text-red-600 font-bold mb-3">â›” ${e.message}</div>`;
                    errorHtml += `<button onclick="firebase.auth().signOut().then(() => window.location.reload())" class="bg-red-500 text-white font-bold py-2 px-6 rounded">ğŸ”„ é‡æ–°ç™»å…¥</button>`;
                    loginMsg.innerHTML = errorHtml;
                }
            } else {
                loginView.classList.remove('hidden');
                appView.classList.add('hidden');
            }
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            auth.signInWithPopup(provider);
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => window.location.reload());
        });

        // -----------------------------------------------------------
        // 3. å„€è¡¨æ¿ (Dashboard)
        // -----------------------------------------------------------
        function getLocalDraftKey(uid, assignmentId) {
            return `ws_draft_${uid}_${assignmentId}`;
        }

        async function renderDashboard() {
            const schoolDisplay = studentProfile.schoolName || studentProfile.schoolId;
            document.getElementById('student-name').textContent = studentProfile.displayName;
            document.getElementById('class-info').textContent = `${schoolDisplay} | ${studentProfile.classId}ç­ ${studentProfile.seatNo}è™Ÿ`;

            const todoList = document.getElementById('todo-list');
            const historyList = document.getElementById('history-list');
            
            // æŠ“å–ç­ç´šä»»å‹™
            const assignsSnap = await db.collection('assignments')
                                        .where('target_class', '==', studentProfile.classId)
                                        .where('school_id', '==', studentProfile.schoolId)
                                        .orderBy('created_at', 'desc')
                                        .get();

            // æŠ“å–å­¸ç”Ÿå·²ç¹³äº¤/æš«å­˜ç´€éŒ„
            const responsesSnap = await db.collection('responses')
                                         .where('student_uid', '==', currentUser.uid)
                                         .get();

            const responseMap = {};
            responsesSnap.forEach(doc => { responseMap[doc.data().assignment_id] = doc.data(); });

            todoList.innerHTML = '';
            historyList.innerHTML = '';
            let todoCount = 0;

            if (assignsSnap.empty) {
                todoList.innerHTML = '<p class="text-center text-gray-500 py-4">ç›®å‰æ²’æœ‰ä½œæ¥­</p>';
                return;
            }

            assignsSnap.forEach(doc => {
                const task = doc.data();
                const taskId = doc.id;
                const userResponse = responseMap[taskId];
                
                const localKey = getLocalDraftKey(currentUser.uid, taskId);
                const hasLocalDraft = localStorage.getItem(localKey) !== null;

                let status = 'new'; 
                if (userResponse) status = userResponse.status;

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow border-l-4 transition hover:shadow-md cursor-pointer flex justify-between items-center gap-4";
                
                const dateObj = task.created_at ? new Date(task.created_at.seconds * 1000) : null;
                const dateStr = dateObj ? `${dateObj.getFullYear()}/${dateObj.getMonth()+1}/${dateObj.getDate()}` : '--/--';

                // ---------------------------------------------------
                // æ­·å²ç´€éŒ„å€ (å·²ç¹³äº¤/å·²æ‰¹æ”¹)
                // ---------------------------------------------------
                if (status === 'submitted' || status === 'graded') {
                    card.classList.add('border-green-500');
                    let scoreHtml = status === 'graded' 
                        ? `<span class="text-green-600 font-bold text-lg whitespace-nowrap">${userResponse.score} åˆ†</span>` 
                        : `<span class="text-gray-500 text-sm whitespace-nowrap">å·²ç¹³äº¤</span>`;
                    
                    card.innerHTML = `
                        <div class="flex-grow overflow-hidden">
                            <h4 class="font-bold text-gray-800 truncate">${task.worksheet_title}</h4>
                            <p class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                                ğŸ“… ${dateStr} ç™¼å¸ƒ
                            </p>
                        </div>
                        <div class="flex-shrink-0 text-right pl-2">
                            ${scoreHtml}
                        </div>
                    `;
                    card.onclick = () => openWorksheet(taskId, task, userResponse, true); 
                    historyList.appendChild(card);
                } 
                // ---------------------------------------------------
                // å¾…è¾¦äº‹é …å€ (æ–°ä½œæ¥­/è‰ç¨¿/è¨‚æ­£)
                // ---------------------------------------------------
                else {
                    todoCount++;
                    let statusLabel = '';
                    let borderColor = 'border-blue-500';

                    if (hasLocalDraft) {
                        statusLabel = `<span class="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded font-bold whitespace-nowrap">ğŸ’¾ æš«å­˜</span>`;
                        borderColor = 'border-gray-400';
                    } else if (status === 'draft') {
                        statusLabel = `<span class="bg-orange-100 text-orange-700 text-xs px-2 py-0.5 rounded font-bold whitespace-nowrap">â˜ï¸ æš«å­˜</span>`;
                        borderColor = 'border-orange-400';
                    } else if (status === 'needs_correction') {
                        statusLabel = `<span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-0.5 rounded font-bold whitespace-nowrap">âš ï¸ è¨‚æ­£</span>`;
                        borderColor = 'border-yellow-400';
                    } else {
                        statusLabel = `<span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded font-bold whitespace-nowrap">ğŸ†• æ–°ä½œæ¥­</span>`;
                    }
                    
                    card.classList.remove('border-blue-500');
                    card.classList.add(borderColor);

                    card.innerHTML = `
                        <div class="flex-grow pr-2">
                            <h4 class="font-bold text-gray-800 text-lg leading-tight mb-1.5">${task.worksheet_title}</h4>
                            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-500">
                                ${statusLabel}
                                <span class="flex items-center gap-1" title="ç™¼å¸ƒæ—¥æœŸ">ğŸ“… ${dateStr}</span>
                                <span class="flex items-center gap-1 ${task.deadline?'text-red-400':''}" title="æˆªæ­¢æ—¥æœŸ">â³ ${task.deadline || 'ç„¡æœŸé™'}</span>
                            </div>
                        </div>
                        <button class="flex-shrink-0 bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm shadow hover:bg-blue-700 whitespace-nowrap">å‰å¾€ä½œç­”</button>
                    `;
                    card.onclick = () => openWorksheet(taskId, task, userResponse, false);
                    todoList.appendChild(card);
                }
            });
            document.getElementById('todo-count').textContent = todoCount;
        }
        
		
 
        // -----------------------------------------------------------
        // 4. å­¸ç¿’å–®é‚è¼¯ (é–‹å•Ÿã€å¡«ç­”ã€ä¸‰æŒ‰éˆ•åŠŸèƒ½)
        // -----------------------------------------------------------
        async function openWorksheet(taskId, taskData, responseData, isReadOnly) {
            currentAssignmentId = taskId;
            // æ¯æ¬¡é–‹å•Ÿéƒ½é‡ç½®è¼‰å…¥çš„ç­”æ¡ˆï¼Œé¿å…è³‡æ–™æ±™æŸ“
            currentLoadedAnswers = {}; 

            const modal = document.getElementById('worksheet-modal');
            const form = document.getElementById('worksheet-form');
            const feedbackArea = document.getElementById('teacher-feedback-area');
            const actionBtns = document.getElementById('action-buttons');
            const readOnlyBtns = document.getElementById('readonly-buttons');
            const statusDiv = document.getElementById('modal-status');
            const statusContainer = document.getElementById('modal-status-container');

            document.getElementById('modal-title').textContent = taskData.worksheet_title;
            
            // ä¸‹è¼‰å­¸ç¿’å–® HTML
            const wsDoc = await db.collection('worksheets').doc(taskData.worksheet_id).get();
            if (!wsDoc.exists) {
                alert('âš ï¸ ç„¡æ³•é–‹å•Ÿï¼šæ­¤å­¸ç¿’å–®å·²è¢«åˆªé™¤ã€‚');
                renderDashboard(); 
                return;
            }
            
            form.innerHTML = wsDoc.data().html_content;
            executeEmbeddedScripts(form);

            statusContainer.innerHTML = ''; 
            
            // --- å¡«å…¥ç­”æ¡ˆé‚è¼¯ ---
            
            // 1. å…ˆå¡«å…¥é›²ç«¯è³‡æ–™
            if (responseData && responseData.answers) {
                // â˜ï¸ã€æ–°å¢ã€‘æ›´æ–°å…¨åŸŸè®Šæ•¸
                currentLoadedAnswers = { ...responseData.answers };
                fillAnswers(form, responseData.answers);
                
                if(responseData.status === 'draft') statusContainer.innerHTML += `<span class="text-xs font-bold px-2 py-0.5 rounded bg-orange-100 text-orange-700">â˜ï¸ è¼‰å…¥é›²ç«¯æš«å­˜</span>`;
                if(responseData.status === 'needs_correction') statusContainer.innerHTML += `<span class="text-xs font-bold px-2 py-0.5 rounded bg-yellow-100 text-yellow-700">âš ï¸ é€€å›è¨‚æ­£</span>`;

                renderGradingFeedback(form, responseData.grading_details);

                if (responseData.comment) {
                    feedbackArea.classList.remove('hidden');
                    document.getElementById('feedback-text').textContent = responseData.comment;
                } else {
                    feedbackArea.classList.add('hidden');
                }
            } else {
                feedbackArea.classList.add('hidden');
                statusContainer.innerHTML += `<span class="text-xs font-bold px-2 py-0.5 rounded bg-blue-100 text-blue-700">ğŸ†• é–‹å§‹ä½œç­”</span>`;
            }

            // 2. æª¢æŸ¥ä¸¦å¡«å…¥æœ¬åœ°æš«å­˜
            if (!isReadOnly) {
                const localKey = getLocalDraftKey(currentUser.uid, taskId);
                const localJson = localStorage.getItem(localKey);
                
                if (localJson) {
                    try {
                        const localDraft = JSON.parse(localJson);
                        console.log("è¼‰å…¥æœ¬åœ°æš«å­˜:", localDraft);
                        // â˜ï¸ã€æ–°å¢ã€‘åˆä½µæœ¬åœ°æš«å­˜åˆ°å…¨åŸŸè®Šæ•¸ (æœ¬åœ°å„ªå…ˆ)
                        currentLoadedAnswers = { ...currentLoadedAnswers, ...localDraft.answers };
                        fillAnswers(form, localDraft.answers);
                        
                        const timeStr = new Date(localDraft.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        statusContainer.innerHTML += `<span class="text-xs font-bold px-2 py-0.5 rounded bg-gray-200 text-gray-700 border border-gray-400">ğŸ’¾ è¼‰å…¥æœ¬æ©Ÿæš«å­˜ (${timeStr})</span>`;
                    } catch(e) { console.error("æœ¬åœ°æš«å­˜è®€å–å¤±æ•—", e); }
                }
            }

            // --- ä»‹é¢æ¨¡å¼åˆ‡æ› ---
            if (isReadOnly) {
                actionBtns.classList.add('hidden');
                readOnlyBtns.classList.remove('hidden');
                form.querySelectorAll('input, textarea, select').forEach(el => el.disabled = true);
            } else {
                actionBtns.classList.remove('hidden');
                readOnlyBtns.classList.add('hidden');
                form.querySelectorAll('input, textarea, select').forEach(el => el.disabled = false);
            }

            modal.classList.remove('hidden');
			loadStudentPositions(); // â˜… åŠ å…¥é€™ä¸€è¡Œ
        }

        // å¡«å¯«è¡¨å–®è¼”åŠ©å‡½å¼ (ä¿®æ”¹ç‰ˆ)
        function fillAnswers(form, answers) {
            form.querySelectorAll('.worksheet-input').forEach(input => {
                const name = input.name;
                if (answers[name] !== undefined) {
                    // â˜ï¸ã€æ–°å¢ã€‘æ”¯æ´æª”æ¡ˆé¡¯ç¤ºé‚è¼¯
                    if (input.type === 'file') {
                        const oldLink = input.parentNode.querySelector('.file-download-link');
                        if (oldLink) oldLink.remove();

                        const val = answers[name];
                        if (val && typeof val === 'string' && val.startsWith('http')) {
                            const link = document.createElement('a');
                            link.href = val;
                            link.target = '_blank';
                            link.className = 'file-download-link text-blue-600 underline text-sm ml-2 font-bold hover:text-blue-800';
                            link.innerHTML = 'ğŸ“‚ å·²ä¸Šå‚³æª”æ¡ˆ (é»æ“ŠæŸ¥çœ‹)';
                            
                            if(input.nextSibling) input.parentNode.insertBefore(link, input.nextSibling);
                            else input.parentNode.appendChild(link);
                        }
                    } 
                    else if (input.type === 'radio' || input.type === 'checkbox') {
                        if (input.value === answers[name]) input.checked = true;
                    } else {
                        input.value = answers[name];
                    }
                }
            });
        }

        function renderGradingFeedback(form, gradingDetails) {
            if (!gradingDetails) return;
            form.querySelectorAll('.worksheet-input').forEach(input => {
                const name = input.name;
                const det = gradingDetails[name];
                if (det && (det.is_correct !== undefined || det.feedback)) {
                    if (input.type === 'radio') {
                        const allRadios = form.querySelectorAll(`input[type="radio"][name="${name}"]`);
                        if (input !== allRadios[allRadios.length - 1]) return; 
                    }

                    const isCor = det.is_correct === true;
                    const isInc = det.is_correct === false;
                    const fb = det.feedback || '';

                    const panel = document.createElement('div');
                    panel.className = `grading-panel ${isCor?'correct':(isInc?'incorrect':'')}`;
                    
                    if (input.type === 'radio') {
                        panel.style.gridColumn = "1 / -1"; panel.style.width = "100%"; panel.style.marginTop = "15px";
                    }

                    let statusIcon = '';
                    if (isCor) statusIcon = '<span class="text-correct">â­• ç­”å°äº†</span>';
                    else if (isInc) statusIcon = '<span class="text-incorrect">âŒ ç­”éŒ¯äº†</span>';

                    let feedbackHtml = fb ? `<div class="mt-2 text-sm text-gray-600 bg-white p-2 rounded border border-gray-200"><strong>ğŸ‘©â€ğŸ« è€å¸«ï¼š</strong>${fb}</div>` : '';
                    panel.innerHTML = `<div class="grading-status-text text-lg">${statusIcon}</div>${feedbackHtml}`;

                    if (input.type === 'radio') {
                        const container = input.parentNode;
                        if(container.nextSibling) container.parentNode.insertBefore(panel, container.nextSibling);
                        else container.parentNode.appendChild(panel);
                    } else {
                        if(input.nextSibling) input.parentNode.insertBefore(panel, input.nextSibling);
                        else input.parentNode.appendChild(panel);
                    }
                }
            });
        }

        function closeModal() { document.getElementById('worksheet-modal').classList.add('hidden'); }

        // â˜ï¸ã€æ–°å¢ã€‘ä¸Šå‚³å–®ä¸€æª”æ¡ˆåˆ° Firebase Storage
        async function uploadFileToStorage(file) {
            if (!file) return null;
            const timestamp = new Date().getTime();
            // è·¯å¾‘çµæ§‹: uploads/ä½œæ¥­ID/å­¸ç”ŸID/æ™‚é–“æˆ³_æª”å
            const path = `uploads/${currentAssignmentId}/${currentUser.uid}/${timestamp}_${file.name}`;
            const ref = storage.ref().child(path);
            
            const snapshot = await ref.put(file);
            return await snapshot.ref.getDownloadURL();
        }

		// â˜ï¸ã€æ–°å¢ã€‘éåŒæ­¥æ”¶é›†ç­”æ¡ˆä¸¦è™•ç†ä¸Šå‚³
        async function collectAnswersAndUpload() {
            const form = document.getElementById('worksheet-form');
            // è¤‡è£½ä¸€ä»½ç›®å‰çš„ç­”æ¡ˆï¼Œä½œç‚ºåŸºåº• (ä¿ç•™æœªä¿®æ”¹çš„èˆŠæª”æ¡ˆé€£çµ)
            const answers = { ...currentLoadedAnswers }; 
            
            // [MOD START] â˜… æ–°å¢ï¼šç”¨ä¾†è¨˜éŒ„å“ªäº› checkbox ç¾¤çµ„å·²ç¶“è¢«åˆå§‹åŒ–(æ¸…ç©ºèˆŠå€¼)é
            const processedCheckboxGroups = new Set();
            // [MOD END]

            const inputs = form.querySelectorAll('.worksheet-input');
            
            for (const input of inputs) {
                if (!input.name) continue;

                if (input.type === 'file') {
                    // å¦‚æœä½¿ç”¨è€…é¸äº†æ–°æª”æ¡ˆ -> ä¸Šå‚³ä¸¦æ›´æ–°ç¶²å€
                    if (input.files && input.files.length > 0) {
                        try {
                            const url = await uploadFileToStorage(input.files[0]);
                            answers[input.name] = url;
                        } catch (e) {
                            console.error(`æª”æ¡ˆ ${input.name} ä¸Šå‚³å¤±æ•—`, e);
                            alert(`æª”æ¡ˆä¸Šå‚³å¤±æ•—ï¼š${input.files[0].name}`);
                            throw e; 
                        }
                    } 
                } 
                else if (input.type === 'radio') { 
                    if (input.checked) answers[input.name] = input.value; 
                } 
                else if (input.type === 'checkbox') { 
                    // [MOD START] ğŸ› ï¸ ä¿®æ”¹è™•ï¼šè¤‡é¸é¡Œé‚è¼¯ä¿®æ­£ (ç´¯ç©å¤šé¸å€¼)
                    
                    // 1. é‡åˆ°è©²é¡Œç›®çš„ç¬¬ä¸€å€‹é¸é …æ™‚ï¼Œå…ˆç§»é™¤èˆŠè³‡æ–™(ä¾†è‡ªcurrentLoadedAnswers)ï¼Œé¿å…æ··é›œåˆ°èˆŠçš„å‹¾é¸
                    if (!processedCheckboxGroups.has(input.name)) {
                        delete answers[input.name]; // æ¸…ç©ºè©²æ¬„ä½
                        processedCheckboxGroups.add(input.name); // æ¨™è¨˜å·²è™•ç†éåˆå§‹åŒ–
                    }

                    // 2. å¦‚æœè©²é¸é …è¢«å‹¾é¸ï¼Œå‰‡é€²è¡Œã€Œå­—ä¸²ä¸²æ¥ã€
                    if (input.checked) { 
                        if (answers[input.name]) {
                            // å¦‚æœè£¡é¢å·²ç¶“æœ‰å€¼ (ä»£è¡¨å‰é¢æœ‰å…¶ä»–é¸é …è¢«å‹¾é¸äº†)ï¼ŒåŠ ä¸Šé€—è™Ÿ
                            answers[input.name] += ',' + input.value;
                        } else {
                            // ç¬¬ä¸€å€‹è¢«å‹¾é¸çš„å€¼
                            answers[input.name] = input.value;
                        }
                    }
                    // [MOD END] ğŸ› ï¸ ä¿®æ”¹çµæŸ
                }
                else {
                    answers[input.name] = input.value;
                }
            }
            
            currentLoadedAnswers = answers;
            return answers;
        }
		
        // ==========================================
        //  ä¸‰æŒ‰éˆ•é‚è¼¯å¯¦ä½œ (æ›´æ–°)
        // ==========================================

        // 1. æš«æ™‚é›¢é–‹ (å­˜æœ¬æ©Ÿ -> é—œé–‰)
        async function saveLocalAndClose() {
            if(document.getElementById('worksheet-modal').classList.contains('hidden')) return;
            const isReadOnly = document.getElementById('btn-submit') ? false : true; 
            if(document.getElementById('action-buttons').classList.contains('hidden')) {
                closeModal(); return;
            }

            // â˜ï¸ æœ¬æ©Ÿæš«å­˜ä¸åŒ…å«æœªä¸Šå‚³çš„æª”æ¡ˆ
            const form = document.getElementById('worksheet-form');
            const simpleAnswers = { ...currentLoadedAnswers };
            form.querySelectorAll('.worksheet-input').forEach(input => {
                if(input.name && input.type !== 'file') { 
                     if (input.type === 'radio' || input.type === 'checkbox') {
                        if (input.checked) simpleAnswers[input.name] = input.value;
                    } else {
                        simpleAnswers[input.name] = input.value;
                    }
                }
            });

            try {
                const key = getLocalDraftKey(currentUser.uid, currentAssignmentId);
                const draftData = { timestamp: new Date().getTime(), answers: simpleAnswers };
                localStorage.setItem(key, JSON.stringify(draftData));
                
                console.log('å·²å­˜å…¥æœ¬æ©Ÿæš«å­˜');
                closeModal();
                renderDashboard(); 
            } catch(e) {
                alert('æœ¬æ©Ÿæš«å­˜å¤±æ•— (å„²å­˜ç©ºé–“å¯èƒ½å·²æ»¿)');
                closeModal();
            }
        }
        document.getElementById('btn-leave-temp').addEventListener('click', saveLocalAndClose);

        // 2. æš«å­˜é›²ç«¯ (éåŒæ­¥ä¸Šå‚³ -> å­˜ Firestore)
        document.getElementById('btn-save-cloud').addEventListener('click', async () => {
            const btn = document.getElementById('btn-save-cloud');
            btn.disabled = true; btn.innerHTML = 'â˜ï¸ ä¸Šå‚³å„²å­˜ä¸­...';

            try {
                // â˜ï¸ åŸ·è¡Œä¸Šå‚³
                const answers = await collectAnswersAndUpload();

                const responseId = `${currentAssignmentId}_${currentUser.uid}`;
                await db.collection('responses').doc(responseId).set({
                    assignment_id: currentAssignmentId,
                    student_uid: currentUser.uid,
                    student_name: studentProfile.displayName,
                    student_no: studentProfile.seatNo,
                    class_id: studentProfile.classId,
                    answers: answers,
                    status: 'draft', 
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                const key = getLocalDraftKey(currentUser.uid, currentAssignmentId);
                localStorage.removeItem(key);

                alert('â˜ï¸ å·²æˆåŠŸä¸Šå‚³ä¸¦æš«å­˜åˆ°é›²ç«¯ï¼');
                closeModal();
                renderDashboard();

            } catch (e) {
                console.error(e); alert('é›²ç«¯å„²å­˜å¤±æ•—: ' + e.message);
            } finally {
                btn.disabled = false; 
                btn.innerHTML = 'â˜ï¸ æš«å­˜é›²ç«¯ <span class="text-xs font-normal text-orange-500">(å¯è·¨è£ç½®)</span>';
            }
        });

        // 3. å®Œæˆç¹³äº¤ (éåŒæ­¥ä¸Šå‚³ -> å­˜ Firestore)
        document.getElementById('btn-submit').addEventListener('click', async () => {
            if(!confirm('ç¢ºå®šè¦ç¹³äº¤ä½œæ¥­å—ï¼Ÿ\nç¹³äº¤å¾Œå°‡ç„¡æ³•å†ä¿®æ”¹ï¼Œç›´åˆ°è€å¸«ç™¼å›ã€‚')) return;

            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.innerHTML = 'ğŸš€ ä¸Šå‚³ä¸¦æäº¤ä¸­...';

            try {
                // â˜ï¸ åŸ·è¡Œä¸Šå‚³
                const answers = await collectAnswersAndUpload();

                const responseId = `${currentAssignmentId}_${currentUser.uid}`;
                await db.collection('responses').doc(responseId).set({
                    assignment_id: currentAssignmentId,
                    student_uid: currentUser.uid,
                    student_name: studentProfile.displayName,
                    student_no: studentProfile.seatNo,
                    class_id: studentProfile.classId,
                    answers: answers,
                    status: 'submitted', 
                    submitted_at: firebase.firestore.FieldValue.serverTimestamp(),
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                const key = getLocalDraftKey(currentUser.uid, currentAssignmentId);
                localStorage.removeItem(key);

                alert('ğŸ‰ ä½œæ¥­å·²æˆåŠŸç¹³äº¤ï¼');
                closeModal();
                renderDashboard();

            } catch (e) {
                console.error(e); alert('ç¹³äº¤å¤±æ•—: ' + e.message);
            } finally {
                btn.disabled = false; 
                btn.innerHTML = '<span>âœ… å®Œæˆç¹³äº¤</span>';
            }
        });
		

		// ==========================================
        // å­¸ç”Ÿç«¯ä½ç½®èˆ‡å¤§å°å¾®èª¿åŠŸèƒ½ (é€²éšç‰ˆ)
        // ==========================================
        let isStudentMoveMode = false;

        function toggleStudentMoveMode() {
            isStudentMoveMode = !isStudentMoveMode;
            const btn = document.getElementById('toggle-move-btn');
            const form = document.getElementById('worksheet-form');
            const inputs = form.querySelectorAll('.worksheet-input');
            const resetBtn = document.getElementById('reset-pos-btn');

            if (isStudentMoveMode) {
                // --- é–‹å•Ÿç·¨è¼¯æ¨¡å¼ ---
                btn.innerHTML = 'ğŸ’¾ é–å®šä¸¦å„²å­˜';
                btn.className = 'bg-orange-600 hover:bg-orange-700 text-white px-5 py-2 rounded-full font-bold text-sm shadow transition flex items-center gap-2';
                resetBtn.classList.remove('hidden');
                
                form.classList.add('move-mode-active');
                
                inputs.forEach(el => {
                    el.setAttribute('readonly', 'true'); // ç¦æ­¢è¼¸å…¥æ–‡å­—
                    
                    // é‡å° radio/checkbox çš„ç‰¹æ®Šè™•ç† (å› ç‚ºå®ƒå€‘é€šå¸¸è¢«åŒ…åœ¨ div è£¡)
                    if(el.type === 'checkbox' || el.type === 'radio') {
                         el.style.pointerEvents = 'none'; // è®“é»æ“Šäº‹ä»¶ç©¿é€åˆ°çˆ¶å±¤ div (å¦‚æœæœ‰)
                         // å¦‚æœæ˜¯ checkboxï¼Œæˆ‘å€‘é€šå¸¸æ‹–æ›³çš„æ˜¯å®ƒçš„å®¹å™¨ï¼Œå¦‚æœæ˜¯ç›´æ¥ inputï¼Œå‰‡ç›´æ¥æ‹–æ›³ input
                         if(el.parentElement.tagName === 'DIV' && el.parentElement.style.position === 'absolute') {
                             enableDragAndResize(el.parentElement);
                             el.parentElement.classList.add('worksheet-input'); // ç¢ºä¿æ¨£å¼åƒåˆ°
                         } else {
                             enableDragAndResize(el);
                         }
                    } else {
                        enableDragAndResize(el);
                    }
                });
                
                alert('é€²å…¥èª¿æ•´æ¨¡å¼ï¼š\n1. æ‹–æ›³ã€Œä¸­é–“ã€å¯ç§»å‹•ä½ç½®\n2. æ‹–æ›³ã€Œå³ä¸‹è§’ã€å¯èª¿æ•´å¤§å°');

            } else {
                // --- é—œé–‰ä¸¦å„²å­˜ ---
                btn.innerHTML = 'ğŸ”“ è§£é–èª¿æ•´ä½ç½®/å¤§å°';
                btn.className = 'bg-gray-700 hover:bg-gray-800 text-white px-5 py-2 rounded-full font-bold text-sm shadow transition flex items-center gap-2';
                resetBtn.classList.add('hidden');
                
                form.classList.remove('move-mode-active');

                inputs.forEach(el => {
                    el.removeAttribute('readonly');
                    if(el.type === 'checkbox' || el.type === 'radio') {
                         el.style.pointerEvents = 'auto'; 
                    }
                    // æ¸…é™¤äº‹ä»¶ç›£è½ï¼Œé‡‹æ”¾è¨˜æ†¶é«”
                    el.onmousedown = null;
                    el.ontouchstart = null;
                    
                    // é‡å° checkbox å®¹å™¨çš„æ¸…ç†
                    if(el.parentElement.tagName === 'DIV' && el.parentElement.classList.contains('worksheet-input')) {
                        el.parentElement.onmousedown = null;
                        el.parentElement.ontouchstart = null;
                        el.parentElement.classList.remove('worksheet-input'); // ç§»é™¤è‡¨æ™‚æ¨£å¼
                    }
                });
                
                // å„²å­˜è¨­å®šåˆ° LocalStorage
                saveStudentPositions();
            }
        }

        function enableDragAndResize(elmnt) {
            let startX = 0, startY = 0, startWidth = 0, startHeight = 0, startLeft = 0, startTop = 0;
            let mode = ''; // 'MOVE' or 'RESIZE'
            
            // ç¶å®šäº‹ä»¶
            elmnt.onmousedown = dragMouseDown;
            elmnt.ontouchstart = dragTouchStart;
            
            // è¦–è¦ºå„ªåŒ–ï¼šæ»‘é¼ ç§»å‹•æ™‚æ”¹è®Šæ¸¸æ¨™ï¼Œæç¤ºä½¿ç”¨è€…å³ä¸‹è§’å¯ç¸®æ”¾
            elmnt.onmousemove = function(e) {
                if (!isStudentMoveMode) return;
                const rect = elmnt.getBoundingClientRect();
                const isCorner = (e.clientX > rect.right - 20 && e.clientY > rect.bottom - 20);
                elmnt.style.cursor = isCorner ? 'nwse-resize' : 'move';
            };

            function dragMouseDown(e) {
                e.preventDefault();
                e.stopPropagation(); // é˜²æ­¢è§¸ç™¼åº•å±¤äº‹ä»¶
                initDrag(e.clientX, e.clientY);
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function dragTouchStart(e) {
                // e.preventDefault(); // è¨»è§£æ‰ï¼Œé¿å…æŸäº›è£ç½®ç„¡æ³•ç¸®æ”¾é é¢ï¼Œä½†åœ¨é€™è£¡éœ€è¦é˜²æ­¢æ»¾å‹•
                if(e.touches.length > 1) return; // å¿½ç•¥å¤šæŒ‡è§¸æ§
                const touch = e.touches[0];
                initDrag(touch.clientX, touch.clientY);
                document.ontouchend = closeDragElement;
                document.ontouchmove = elementDragTouch;
            }

            function initDrag(clientX, clientY) {
                const rect = elmnt.getBoundingClientRect();
                // åˆ¤å®šï¼šé»æ“Šä½ç½®æ˜¯å¦åœ¨å³ä¸‹è§’ 20x20 å€åŸŸå…§
                const isCorner = (clientX > rect.right - 20 && clientY > rect.bottom - 20);
                
                mode = isCorner ? 'RESIZE' : 'MOVE';
                
                startX = clientX;
                startY = clientY;
                
                // ç´€éŒ„åˆå§‹ç‹€æ…‹ (px)
                startWidth = parseFloat(getComputedStyle(elmnt).width);
                startHeight = parseFloat(getComputedStyle(elmnt).height);
                startLeft = elmnt.offsetLeft;
                startTop = elmnt.offsetTop;
            }

            function elementDrag(e) {
                e.preventDefault();
                performAction(e.clientX, e.clientY);
            }

            function elementDragTouch(e) {
                // e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿç•«é¢è·Ÿè‘—æ²å‹•
                const touch = e.touches[0];
                performAction(touch.clientX, touch.clientY);
            }

            function performAction(currentX, currentY) {
                const dx = currentX - startX;
                const dy = currentY - startY;

                if (mode === 'MOVE') {
                    elmnt.style.left = (startLeft + dx) + "px";
                    elmnt.style.top = (startTop + dy) + "px";
                } else if (mode === 'RESIZE') {
                    // é™åˆ¶æœ€å°å°ºå¯¸ï¼Œé¿å…æ‹‰åˆ°æ¶ˆå¤±
                    const newW = Math.max(20, startWidth + dx);
                    const newH = Math.max(20, startHeight + dy);
                    elmnt.style.width = newW + "px";
                    elmnt.style.height = newH + "px";
                }
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                document.ontouchend = null;
                document.ontouchmove = null;

                // â˜… é—œéµï¼šå‹•ä½œçµæŸå¾Œï¼Œå°‡ px è½‰æ›å› % (Responsive Design)
                // é€™æ¨£åœ¨ä¸åŒè¢å¹•å°ºå¯¸ä¸‹ï¼Œç›¸å°ä½ç½®å’Œå¤§å°æ‰æœƒæ­£ç¢º
                const parent = elmnt.offsetParent || document.getElementById('worksheet-form'); // Fallback
                if (parent) {
                    const parentW = parent.offsetWidth;
                    const parentH = parent.offsetHeight;

                    const pctLeft = (elmnt.offsetLeft / parentW * 100).toFixed(4) + '%';
                    const pctTop = (elmnt.offsetTop / parentH * 100).toFixed(4) + '%';
                    const pctW = (elmnt.offsetWidth / parentW * 100).toFixed(4) + '%';
                    const pctH = (elmnt.offsetHeight / parentH * 100).toFixed(4) + '%';

                    elmnt.style.left = pctLeft;
                    elmnt.style.top = pctTop;
                    
                    // åªæœ‰åœ¨ Resize æ¨¡å¼æˆ–æ˜¯å¯¬åº¦ç¢ºå¯¦è¢«æ”¹è®Šæ™‚æ‰å¯«å…¥ width/height
                    // é¿å…åªæ˜¯ç§»å‹•å»å°è‡´å¯¬åº¦å› ç‚ºå°æ•¸é»èª¤å·®è€Œè·‘æ‰
                    if (mode === 'RESIZE') {
                        elmnt.style.width = pctW;
                        elmnt.style.height = pctH;
                    }
                }
            }
        }

        // å„²å­˜å¾®èª¿ä½ç½®èˆ‡å¤§å°
        function saveStudentPositions() {
            if(!currentAssignmentId) return;
            const settings = {};
            const form = document.getElementById('worksheet-form');
            
            // å„²å­˜ä¸€èˆ¬è¼¸å…¥æ¡†
            form.querySelectorAll('.worksheet-input').forEach(el => {
                // ç•¥éæ²’æœ‰ name çš„è£é£¾å…ƒç´ ï¼Œä¸”æ’é™¤ checkbox å…§éƒ¨çš„ input (å› ç‚ºæˆ‘å€‘è¦å­˜çš„æ˜¯å¤–å±¤ div)
                if(el.name && el.type !== 'checkbox' && el.type !== 'radio') {
                    settings[el.name] = { 
                        l: el.style.left, 
                        t: el.style.top,
                        w: el.style.width,
                        h: el.style.height
                    };
                }
            });

            // ç‰¹åˆ¥è™•ç† Checkbox/Radio çš„å®¹å™¨ (å› ç‚ºå®ƒå€‘åŒ…åœ¨ div è£¡)
            form.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(el => {
                if(el.name && el.parentElement.tagName === 'DIV' && el.parentElement.style.position === 'absolute') {
                     settings['container_' + el.name] = {
                        l: el.parentElement.style.left, 
                        t: el.parentElement.style.top,
                        w: el.parentElement.style.width,
                        h: el.parentElement.style.height
                     };
                }
            });

            const key = `ws_layout_${currentUser.uid}_${currentAssignmentId}`;
            localStorage.setItem(key, JSON.stringify(settings));
            alert('âœ… ç‰ˆé¢è¨­å®šå·²å„²å­˜ (æœ¬æ©Ÿ)');
        }

        // è¼‰å…¥å¾®èª¿ä½ç½®èˆ‡å¤§å°
        function loadStudentPositions() {
            if(!currentAssignmentId) return;
            const key = `ws_layout_${currentUser.uid}_${currentAssignmentId}`;
            const saved = localStorage.getItem(key);
            
            // é¡¯ç¤ºèª¿æ•´æŒ‰éˆ•
            document.getElementById('adjust-controls').classList.remove('hidden');

            if(saved) {
                try {
                    const settings = JSON.parse(saved);
                    const form = document.getElementById('worksheet-form');

                    // æ¢å¾©ä¸€èˆ¬è¼¸å…¥æ¡†
                    Object.keys(settings).forEach(name => {
                        if(name.startsWith('container_')) {
                            // æ¢å¾© checkbox/radio å®¹å™¨
                            const realName = name.replace('container_', '');
                            const input = form.querySelector(`input[name="${realName}"]`);
                            if(input && input.parentElement) {
                                const s = settings[name];
                                if(s.l) input.parentElement.style.left = s.l;
                                if(s.t) input.parentElement.style.top = s.t;
                                if(s.w) input.parentElement.style.width = s.w;
                                if(s.h) input.parentElement.style.height = s.h;
                            }
                        } else {
                            // æ¢å¾©ä¸€èˆ¬è¼¸å…¥æ¡†
                            const el = form.querySelector(`[name="${name}"]`);
                            if(el) {
                                const s = settings[name];
                                if(s.l) el.style.left = s.l;
                                if(s.t) el.style.top = s.t;
                                if(s.w) el.style.width = s.w;
                                if(s.h) el.style.height = s.h;
                            }
                        }
                    });
                    console.log('å·²è¼‰å…¥è‡ªè¨‚ç‰ˆé¢é…ç½®');
                } catch(e) { console.error('ç‰ˆé¢è¼‰å…¥å¤±æ•—', e); }
            }
        }

        function resetStudentPositions() {
            if(!confirm('ç¢ºå®šè¦é‡ç½®å›è€å¸«é è¨­çš„ç‰ˆé¢å—ï¼Ÿ\n(æ‚¨è‡ªè¨‚çš„ä½ç½®èˆ‡å¤§å°å°‡è¢«æ¸…é™¤)')) return;
            const key = `ws_layout_${currentUser.uid}_${currentAssignmentId}`;
            localStorage.removeItem(key);
            location.reload(); 
        }

    </script>
</body>
</html>
