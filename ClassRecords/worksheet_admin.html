
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’å–®ç³»çµ± - å­¸æ ¡ç®¡ç†å¾Œå°</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --danger-color: #d0021b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { margin: 0; font-size: 1.5rem; }
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card h2 { margin-top: 0; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; display: inline-block;}
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        textarea {
            height: 200px;
            font-family: monospace;
            margin-bottom: 10px;
        }
        
        /* å­¸æ ¡ ID è¼¸å…¥æ¡†ç‰¹åˆ¥æ¨£å¼ (é–å®šç‹€æ…‹) */
        #school-id-input {
            border: 2px solid #ccc;
            background-color: #e9ecef;
            font-weight: bold;
            color: #495057;
            cursor: not-allowed;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        button:hover { background-color: #357abd; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .status-box {
            margin-top: 10px;
            padding: 10px;
            background-color: #eef;
            border-radius: 4px;
            font-size: 0.9rem;
            display: none; 
        }
        .error { color: var(--danger-color); font-weight: bold; }
        .success { color: #28a745; }

        #app-view { display: none; }
        #login-view { text-align: center; margin-top: 100px; }
        
        /* è¼‰å…¥ä¸­é®ç½© */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: none; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #555;">æ­£åœ¨é©—è­‰æ¬Šé™...</p>
    </div>

    <div id="login-view">
        <h1>è«‹å…ˆç™»å…¥å­¸æ ¡ç®¡ç†å“¡å¸³è™Ÿ</h1>
        <p>è«‹ä½¿ç”¨å…·æœ‰ <code>school_admin</code> æ¬Šé™çš„ Google å¸³è™Ÿç™»å…¥</p>
        <button id="login-btn">Google ç™»å…¥</button>
        <p id="login-msg" style="color: red; margin-top: 15px;"></p>
    </div>

    <div id="app-view" class="container">
        <header>
            <div>
                <h1>å­¸æ ¡ç®¡ç†å¾Œå°</h1>
                <span id="user-info" style="font-size: 0.9em; color: #666;"></span>
            </div>
            <button id="logout-btn" style="background-color: #666;">ç™»å‡º</button>
        </header>

        <div class="card">
            <h2>0. ç›®å‰ç®¡ç†çš„å­¸æ ¡ (School ID)</h2>
            <p>ç³»çµ±å·²æ ¹æ“šæ‚¨çš„å¸³è™Ÿæ¬Šé™ï¼Œè‡ªå‹•é–å®šå­¸æ ¡ IDã€‚</p>
            <input type="text" id="school-id-input" disabled title="æ­¤æ¬„ä½ç”±ç³»çµ±è‡ªå‹•å¸¶å…¥ï¼Œä¸å¯ä¿®æ”¹">
        </div>

        <div class="card">
            <h2>1. ç³»çµ±åˆå§‹åŒ– (å»ºç«‹è³‡æ–™åº«çµæ§‹)</h2>
            <p>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè«‹é»æ“Šæ­¤æŒ‰éˆ•ä»¥å»ºç«‹å¿…è¦çš„è³‡æ–™é›†åˆã€‚</p>
            <button id="init-db-btn">åŸ·è¡Œåˆå§‹åŒ–</button>
            <div id="init-status" class="status-box"></div>
        </div>

        <div class="card">
            <h2>2. åŒ¯å…¥å­¸ç”Ÿåå–®</h2>
            <p>è«‹å°‡ Excel è³‡æ–™è¤‡è£½è²¼ä¸Šè‡³ä¸‹æ–¹ã€‚æ ¼å¼ï¼š<code>ç­ç´šåº§è™Ÿ,å§“å,email</code> (ä¸­é–“ç”¨é€—è™Ÿåˆ†éš”)</p>
            <div style="background: #f9f9f9; padding: 10px; border-left: 4px solid #aaa; margin-bottom: 15px; font-size: 0.9em;">
                <strong>ç¯„ä¾‹ï¼š</strong><br>
                10101,ç‹å°æ˜,student01@apps.ntpc.edu.tw<br>
                10102,é™³å¤§è¯,student02@apps.ntpc.edu.tw
            </div>
            <textarea id="csv-input" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šè³‡æ–™..."></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button id="import-btn">é–‹å§‹åŒ¯å…¥</button>
                <span id="import-summary" style="color: #666;"></span>
            </div>
            <div id="import-status" class="status-box"></div>
        </div>

    </div>

    <script>
        // --------------------------------------------------------
        // 1. Firebase è¨­å®š
        // --------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAVLFoqQlSR5NK_ZaWgL07eA2LMsfHT_Ew",
            authDomain: "classrecords-13902.firebaseapp.com",
            projectId: "classrecords-13902",
            storageBucket: "classrecords-13902.firebasestorage.app",
            messagingSenderId: "431747377367",
            appId: "1:431747377367:web:b157a485c59ce38091e892",
            measurementId: "G-JWTQGM9XMP"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentUser = null;
        let currentSchoolId = null;

        // --------------------------------------------------------
        // 2. èº«åˆ†é©—è­‰èˆ‡åš´æ ¼æ¬Šé™æª¢æŸ¥
        // --------------------------------------------------------
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const userInfo = document.getElementById('user-info');
        const schoolIdInput = document.getElementById('school-id-input');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginMsg = document.getElementById('login-msg');

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                loadingOverlay.style.display = 'flex';
                loginMsg.textContent = '';

                try {
                    // 1. è®€å–ä½¿ç”¨è€…åœ¨ Firestore çš„è³‡æ–™ (users/{uid})
                    const userDoc = await db.collection('users').doc(user.uid).get();

                    if (!userDoc.exists) {
                        throw new Error("æ‰¾ä¸åˆ°æ‚¨çš„ä½¿ç”¨è€…è³‡æ–™ã€‚è«‹ç¢ºèªæ‚¨å·²åœ¨ä¸»ç³»çµ±è¨»å†Šã€‚");
                    }

                    const userData = userDoc.data();
                    console.log("ä½¿ç”¨è€…è³‡æ–™è¼‰å…¥:", userData);

                    // 2. åš´æ ¼æª¢æŸ¥ Role (å¿…é ˆæ˜¯ school_admin æˆ– admin)
                    if (userData.role !== 'school_admin' && userData.role !== 'admin') {
                        throw new Error(`æ¬Šé™ä¸è¶³ï¼æ‚¨çš„èº«åˆ†æ˜¯ (${userData.role})ï¼Œåªæœ‰ school_admin å¯ä»¥å­˜å–æ­¤é é¢ã€‚`);
                    }

                    // 3. æª¢æŸ¥ä¸¦é–å®š School ID
                    if (!userData.schoolId) {
                        throw new Error("æ‚¨çš„å¸³è™Ÿå°šæœªç¶å®šå­¸æ ¡ä»£ç¢¼ (schoolId)ï¼Œç„¡æ³•é€²è¡Œç®¡ç†ã€‚");
                    }

                    // é©—è­‰é€šé
                    currentUser = user;
                    currentSchoolId = userData.schoolId;
                    
                    // ğŸŸ¢ [ä¿®æ”¹] é¡¯ç¤º Firestore ä¸­çš„ displayName æ¬„ä½ï¼Œè€Œé Google å¸³è™Ÿåç¨±
                    userInfo.textContent = `æ­¡è¿, ${userData.displayName} (${userData.role})`;
                    
                    schoolIdInput.value = currentSchoolId; // è‡ªå‹•å¡«å…¥
                    
                    loadingOverlay.style.display = 'none';
                    loginView.style.display = 'none';
                    appView.style.display = 'block';

                } catch (error) {
                    console.error("é©—è­‰å¤±æ•—:", error);
                    alert("ç™»å…¥å¤±æ•—: " + error.message);
                    
                    // å¼·åˆ¶ç™»å‡º
                    auth.signOut();
                    loadingOverlay.style.display = 'none';
                    loginView.style.display = 'block';
                    loginMsg.textContent = error.message;
                }

            } else {
                currentUser = null;
                loadingOverlay.style.display = 'none';
                loginView.style.display = 'block';
                appView.style.display = 'none';
            }
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider);
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut();
        });

        // --------------------------------------------------------
        // 3. Step 2: è‡ªå‹•å»ºç«‹è³‡æ–™åº«çµæ§‹
        // --------------------------------------------------------
        document.getElementById('init-db-btn').addEventListener('click', async () => {
            if (!currentSchoolId) return alert("éŒ¯èª¤ï¼šæœªå–å¾—å­¸æ ¡ ID");

            const statusBox = document.getElementById('init-status');
            statusBox.style.display = 'block';
            statusBox.textContent = `æ­£åœ¨åˆå§‹åŒ–å­¸æ ¡ (${currentSchoolId}) è³‡æ–™åº«çµæ§‹...`;

            try {
                const batch = db.batch();

                // 1. å»ºç«‹/ç¢ºèªå­¸æ ¡è¨­å®šæª”
                const schoolRef = db.collection('schools').doc(currentSchoolId);
                batch.set(schoolRef, {
                    last_initialized: firebase.firestore.FieldValue.serverTimestamp(),
                    system_version: "2.0_worksheet_system",
                    admin_email: currentUser.email
                }, { merge: true });

                // 2. å»ºç«‹ã€Œå­¸ç¿’å–®æ¨£æ¿ã€(Worksheets) é›†åˆ
                const sampleWorksheetRef = db.collection('worksheets').doc('_sample_template');
                batch.set(sampleWorksheetRef, {
                    title: "ç³»çµ±ç¯„ä¾‹å­¸ç¿’å–®",
                    creator_id: "system",
                    created_at: firebase.firestore.FieldValue.serverTimestamp(),
                    html_content: "<div>é€™æ˜¯ä¸€å€‹ç¯„ä¾‹</div>",
                    is_sample: true
                });

                // 3. å»ºç«‹ã€ŒæŒ‡æ´¾ä»»å‹™ã€(Assignments) é›†åˆ
                const sampleAssignRef = db.collection('assignments').doc('_sample_assignment');
                batch.set(sampleAssignRef, {
                    worksheet_id: "_sample_template",
                    target_class: "000",
                    status: "draft"
                });

                await batch.commit();
                statusBox.innerHTML = `<span class="success">âœ… åˆå§‹åŒ–æˆåŠŸï¼å­¸æ ¡ IDï¼š${currentSchoolId} å·²æº–å‚™å°±ç·’ã€‚</span>`;
            } catch (error) {
                console.error(error);
                statusBox.innerHTML = `<span class="error">âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}<br>è«‹ç¢ºèª Firebase å®‰å…¨è¦å‰‡æ˜¯å¦æ­£ç¢ºã€‚</span>`;
            }
        });

        // --------------------------------------------------------
        // 4. Step 3: åŒ¯å…¥å­¸ç”Ÿåå–®
        // --------------------------------------------------------
        document.getElementById('import-btn').addEventListener('click', async () => {
            if (!currentSchoolId) return alert("éŒ¯èª¤ï¼šæœªå–å¾—å­¸æ ¡ ID");
            
            const inputVal = document.getElementById('csv-input').value.trim();
            const statusBox = document.getElementById('import-status');
            const btn = document.getElementById('import-btn');
            
            if (!inputVal) {
                alert("è«‹è¼¸å…¥å­¸ç”Ÿ CSV è³‡æ–™");
                return;
            }

            btn.disabled = true;
            statusBox.style.display = 'block';
            statusBox.textContent = 'æ­£åœ¨è§£æä¸¦ä¸Šå‚³è³‡æ–™...';

            const lines = inputVal.split('\n');
            let batch = db.batch();
            let batchCount = 0;
            let successCount = 0;
            let failCount = 0;
            const batchCommitPromises = [];

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // è§£æ CSV: 10102,ç‹å¤§æ˜,abcd@...
                const parts = line.split(',').map(p => p.trim());

                if (parts.length < 3) {
                    console.warn("ç•¥éæ ¼å¼éŒ¯èª¤è¡Œ:", line);
                    failCount++;
                    continue;
                }

                const fullId = parts[0];  // 10102
                const name = parts[1];    // ç‹å¤§æ˜
                const email = parts[2];   // email

                // è‡ªå‹•è§£æé‚è¼¯ï¼šå‰3ç¢¼ç‚ºç­ç´šï¼Œå¾Œ2ç¢¼ç‚ºåº§è™Ÿ
                const classId = fullId.substring(0, 3);
                const seatNo = fullId.substring(3);

                // ä½¿ç”¨ Email ç”¢ç”Ÿå®‰å…¨çš„ Document ID
                const safeEmailKey = email.replace(/[@.]/g, '_');

                // å¯«å…¥è·¯å¾‘: schools/{currentSchoolId}/students/{safeEmailKey}
                const docRef = db.collection('schools').doc(currentSchoolId).collection('students').doc(safeEmailKey);

                const studentData = {
                    full_id: fullId,   
                    class_id: classId, 
                    seat_no: seatNo,   
                    name: name,
                    email: email,
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                };

                batch.set(docRef, studentData, { merge: true });
                batchCount++;
                successCount++;

                if (batchCount >= 450) {
                    batchCommitPromises.push(batch.commit());
                    batch = db.batch();
                    batchCount = 0;
                }
            }

            if (batchCount > 0) {
                batchCommitPromises.push(batch.commit());
            }

            try {
                await Promise.all(batchCommitPromises);
                statusBox.innerHTML = `<span class="success">âœ… åŒ¯å…¥å®Œæˆï¼<br>ç›®æ¨™å­¸æ ¡: ${currentSchoolId}<br>æˆåŠŸ: ${successCount} ç­†<br>å¤±æ•—/æ ¼å¼éŒ¯: ${failCount} ç­†</span>`;
                document.getElementById('csv-input').value = ''; 
            } catch (error) {
                console.error(error);
                statusBox.innerHTML = `<span class="error">âŒ å¯«å…¥è³‡æ–™åº«å¤±æ•—: ${error.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        });

    </script>
</body>
</html>
